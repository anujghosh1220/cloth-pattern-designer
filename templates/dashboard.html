{% extends "base.html" %}

{% block title %}Dashboard - Cloth Pattern Designer{% endblock %}

{% block extra_css %}
<style>
    .measurement-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .pattern-preview {
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .pattern-preview img {
        max-width: 100%;
        height: auto;
    }
    .form-section {
        margin-bottom: 30px;
    }
    .saved-measurements {
        margin-top: 30px;
    }
    .measurement-card {
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .measurement-card:hover {
        background-color: #f1f1f1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dashboard</h2>
        <div>
            {% if current_user.username == 'admin' %}
            <button class="btn btn-outline-primary me-2" id="allMeasurementsBtn">
                <i class="bi bi-collection"></i> All Measurements
            </button>
            {% else %}
            <button class="btn btn-outline-primary me-2" id="myMeasurementsBtn">
                <i class="bi bi-person-lines-fill"></i> My Measurements
            </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Pattern Categories -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex gap-2">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Select Category
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="categoryDropdown">
                                <li><a class="dropdown-item pattern-category active" href="#" data-category="blouse" onclick="event.preventDefault(); document.getElementById('category').value='blouse'; updateMeasurementFields('blouse'); document.getElementById('categoryDropdown').innerHTML='Blouse';">Blouse</a></li>
                                <li><a class="dropdown-item pattern-category" href="#" data-category="kurti" onclick="event.preventDefault(); document.getElementById('category').value='kurti'; updateMeasurementFields('kurti'); document.getElementById('categoryDropdown').innerHTML='Kurti';">Kurti</a></li>
                                <li><a class="dropdown-item pattern-category" href="#" data-category="lehenga" onclick="event.preventDefault(); document.getElementById('category').value='lehenga'; updateMeasurementFields('lehenga'); document.getElementById('categoryDropdown').innerHTML='Lehenga';">Lehenga</a></li>
                                <li><hr class="dropdown-divider">
                                <li><a class="dropdown-item pattern-category" href="#" data-category="pant" onclick="event.preventDefault(); document.getElementById('category').value='pant'; updateMeasurementFields('pant'); document.getElementById('categoryDropdown').innerHTML='Pant';">Pant</a></li>
                            </ul>
                        </div>
                        <button type="button" class="btn btn-outline-secondary" id="backToSelectionBtn">
                            <i class="bi bi-arrow-left"></i> Back to Customer Selection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-body">
                    <!-- Customer Selection Screen (Initial View) -->
                    <div id="customerSelectionScreen">
                        <div class="text-center mb-4">
                            <h4>Customer Selection</h4>
                            <p class="text-muted">Choose customer type to continue</p>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm hover-shadow transition-all" style="border-left: 4px solid #0d6efd !important;">
                                    <div class="card-body text-center p-4">
                                        <div class="icon-wrapper mb-3">
                                            <div class="bg-primary bg-opacity-10 p-3 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                                <i class="bi bi-person-plus-fill text-primary" style="font-size: 2.2rem;"></i>
                                            </div>
                                        </div>
                                        <h5 class="card-title fw-bold text-dark mb-2">New Customer</h5>
                                        <p class="card-text text-muted small mb-4">Create and save measurements for a new customer profile</p>
                                        <button type="button" class="btn btn-primary px-4 rounded-pill fw-medium" id="newCustomerBtn">
                                            <i class="bi bi-plus-lg me-2"></i> New Customer
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm hover-shadow transition-all" style="border-left: 4px solid #28a745 !important;">
                                    <div class="card-body text-center p-4">
                                        <div class="icon-wrapper mb-3">
                                            <div class="bg-success bg-opacity-10 p-3 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                                <i class="bi bi-people-fill text-success" style="font-size: 2.2rem;"></i>
                                            </div>
                                        </div>
                                        <h5 class="card-title fw-bold text-dark mb-2">Existing Customer</h5>
                                        <p class="card-text text-muted small mb-4">Quickly access and manage your saved customer profiles</p>
                                        <button type="button" class="btn btn-success px-4 rounded-pill fw-medium" id="existingCustomerBtn">
                                            <i class="bi bi-search me-2"></i> Find Customer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- New Customer Form (Hidden by default) -->
                    <div id="newCustomerForm" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="mb-0">New Customer</h4>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="backToCustomerSelection">
                                <i class="bi bi-arrow-left"></i> Back
                            </button>
                        </div>
                        
                        <form id="customerInfoForm">
                            <div class="mb-3">
                                <label for="customerName" class="form-label">Full Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="customerName" required>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="customerPhone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="customerPhone" placeholder="+91">
                                </div>
                                <div class="col-md-6">
                                    <label for="customerEmail" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="customerEmail">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="customerAddress" class="form-label">Address</label>
                                <textarea class="form-control" id="customerAddress" rows="2"></textarea>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg"></i> Save Customer & Continue
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Customer Details and Pattern Section -->
                    <div id="customerDetailsSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>Customer Details</h4>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="editCustomerBtn">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 id="displayCustomerName"></h5>
                                        <p class="mb-1"><i class="bi bi-telephone"></i> <span id="displayCustomerPhone"></span></p>
                                        <p class="mb-1"><i class="bi bi-envelope"></i> <span id="displayCustomerEmail"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><i class="bi bi-geo-alt"></i> <span id="displayCustomerAddress"></span></p>
                                        <p class="mb-1"><i class="bi bi-currency-rupee"></i> <span id="displayCustomerAmount">0.0</span></p>
                                        <div class="input-group input-group-sm mb-1">
                                            <span class="input-group-text"><i class="bi bi-currency-rupee"></i> Advance</span>
                                            <input type="number" class="form-control" id="advanceAmount" placeholder="Enter advance amount" disabled>
                                        </div>
                                        <div class="mb-1">
                                            <i class="bi bi-calendar-check"></i>
                                            <input type="date" id="orderDate" class="form-control form-control-sm d-inline-block w-auto">
                                        </div>
                                        <div class="mb-1">
                                            <i class="bi bi-calendar-event"></i>
                                            <input type="date" id="deliveryDate" class="form-control form-control-sm d-inline-block w-auto">
                                        </div>
                                        <div class="mt-3 d-flex gap-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary view-notes" id="customerNotesBtn" disabled>
                                                <i class="bi bi-pencil-square"></i> Notes
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info record-audio" id="customerAudioBtn" disabled>
                                                <i class="bi bi-mic"></i> Record Audio
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-warning" id="updateAmountBtn">
                                                <i class="bi bi-plus-circle"></i> Add Amount
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="patternPreviewContainer">
                            <!-- Pattern preview will be loaded here -->
                        </div>
                        
                        <!-- Success Message (initially hidden) -->
                        <div id="successMessage" class="alert alert-success mt-3" style="display: none;">
                            <i class="bi bi-check-circle-fill"></i> 
                            <span id="successMessageText">Measurements and image saved successfully!</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
                <div class="measurement-section" style="display: none;" id="measurementSection">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Measurements</h4>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleMeasurements">
                            <i class="bi bi-chevron-up"></i>
                        </button>
                    </div>
                </div>
                <div id="measurementsCollapse">
                <form id="measurementForm" enctype="multipart/form-data">
                    <input type="hidden" id="category" name="category" value="">
                    <input type="hidden" id="customer_id" name="customer_id" value="">

                    <!-- Blouse Measurements -->
                    <div id="blouseMeasurements" class="measurement-category" style="display: none;">
                        <h4>Blouse Measurements</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="blouse_length" class="form-label">Length</label>
                                <input type="number" class="form-control" id="blouse_length" name="blouse_length" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="blouse_across_shoulder" class="form-label">Across Shoulder</label>
                                <input type="number" class="form-control" id="blouse_across_shoulder" name="blouse_across_shoulder" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="blouse_upper_chest" class="form-label">Round Upper Chest</label>
                                <input type="number" class="form-control" id="blouse_upper_chest" name="blouse_upper_chest" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="blouse_chest" class="form-label">Round Chest</label>
                                <input type="number" class="form-control" id="blouse_chest" name="blouse_chest" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="blouse_waist" class="form-label">Round Waist</label>
                                <input type="number" class="form-control" id="blouse_waist" name="blouse_waist" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="blouse_shoulder_apex" class="form-label">Shoulder to Apex Point</label>
                                <input type="number" class="form-control" id="blouse_shoulder_apex" name="blouse_shoulder_apex" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="blouse_front_neck" class="form-label">Front Neck Depth</label>
                                <input type="number" class="form-control" id="blouse_front_neck" name="blouse_front_neck_depth" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="blouse_back_neck" class="form-label">Back Neck Depth</label>
                                <input type="number" class="form-control" id="blouse_back_neck" name="blouse_back_neck_depth" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="blouse_sleeve_length" class="form-label">Sleeve Length</label>
                                <input type="number" class="form-control" id="blouse_sleeve_length" name="blouse_sleeve_length" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="blouse_armhole" class="form-label">Armhole</label>
                                <input type="number" class="form-control" id="blouse_armhole" name="blouse_armhole" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="blouse_biceps" class="form-label">Biceps</label>
                                <input type="number" class="form-control" id="blouse_biceps" name="blouse_biceps" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="blouse_sleeve_cuff" class="form-label">Sleeve Cuff</label>
                                <input type="number" class="form-control" id="blouse_sleeve_cuff" name="blouse_sleeve_cuff" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- Kurti Measurements -->
                    <div id="kurtiMeasurements" class="measurement-category" style="display: none;">
                        <h4>Kurti Measurements</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="kurti_length" class="form-label">Length</label>
                                <input type="number" class="form-control" id="kurti_length" name="kurti_length" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="kurti_across_shoulder" class="form-label">Across Shoulder</label>
                                <input type="number" class="form-control" id="kurti_across_shoulder" name="kurti_across_shoulder" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="kurti_upper_chest" class="form-label">Round Upper Chest</label>
                                <input type="number" class="form-control" id="kurti_upper_chest" name="kurti_upper_chest" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="kurti_chest" class="form-label">Round Chest</label>
                                <input type="number" class="form-control" id="kurti_chest" name="kurti_chest" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="kurti_waist" class="form-label">Round Waist</label>
                                <input type="number" class="form-control" id="kurti_waist" name="kurti_waist" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="kurti_hip" class="form-label">Round Hip</label>
                                <input type="number" class="form-control" id="kurti_hip" name="kurti_hip" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="kurti_front_neck" class="form-label">Front Neck Depth</label>
                                <input type="number" class="form-control" id="kurti_front_neck" name="kurti_front_neck_depth" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="kurti_back_neck" class="form-label">Back Neck Depth</label>
                                <input type="number" class="form-control" id="kurti_back_neck" name="kurti_back_neck_depth" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="kurti_sleeve_length" class="form-label">Sleeve Length</label>
                                <input type="number" class="form-control" id="kurti_sleeve_length" name="kurti_sleeve_length" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="kurti_armhole" class="form-label">Armhole</label>
                                <input type="number" class="form-control" id="kurti_armhole" name="kurti_armhole" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="kurti_biceps" class="form-label">Biceps</label>
                                <input type="number" class="form-control" id="kurti_biceps" name="kurti_biceps" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="kurti_sleeve_cuff" class="form-label">Sleeve Cuff</label>
                                <input type="number" class="form-control" id="kurti_sleeve_cuff" name="kurti_sleeve_cuff" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- Lehenga Measurements -->
                    <div id="lehengaMeasurements" class="measurement-category" style="display: none;">
                        <h4>Lehenga Measurements</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="lehenga_waist_floor" class="form-label">Waist to Floor Length</label>
                                <input type="number" class="form-control" id="lehenga_waist_floor" name="lehenga_waist_floor" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="lehenga_belt" class="form-label">Round Belt</label>
                                <input type="number" class="form-control" id="lehenga_belt" name="lehenga_belt" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="lehenga_hip" class="form-label">Round Hip</label>
                                <input type="number" class="form-control" id="lehenga_hip" name="lehenga_hip" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- Pant Measurements -->
                    <div id="pantMeasurements" class="measurement-category" style="display: none;">
                        <h4>Pant Measurements</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="pant_waist_ankle" class="form-label">Waist to Ankle Length</label>
                                <input type="number" class="form-control" id="pant_waist_ankle" name="pant_waist_ankle" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="pant_waist_floor" class="form-label">Waist to Floor Length</label>
                                <input type="number" class="form-control" id="pant_waist_floor" name="pant_waist_floor" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="pant_belt" class="form-label">Round Belt</label>
                                <input type="number" class="form-control" id="pant_belt" name="pant_belt" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="pant_hip" class="form-label">Round Hip</label>
                                <input type="number" class="form-control" id="pant_hip" name="pant_hip" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="pant_thigh" class="form-label">Round Thigh</label>
                                <input type="number" class="form-control" id="pant_thigh" name="pant_thigh" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="pant_ankle" class="form-label">Round Ankle</label>
                                <input type="number" class="form-control" id="pant_ankle" name="pant_ankle" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="cloth_image" class="form-label">Upload Cloth Image (Optional)</label>
                        <div class="input-group">
                            <input type="file" class="form-control" id="cloth_image" accept="image/*" style="display: none;">
                            <input type="text" class="form-control" id="imageFileName" placeholder="No image captured" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="cameraBtn">
                                <i class="bi bi-camera"></i> Camera
                            </button>
                        </div>
                        <!-- Camera Preview Modal -->
                        <div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Take a Picture</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body text-center">
                                        <video id="video" width="100%" autoplay playsinline style="background-color: #f8f9fa;"></video>
                                        <canvas id="canvas" style="display: none;"></canvas>
                                    </div>
                                    <div class="modal-footer justify-content-center">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" id="captureBtn">
                                            <i class="bi bi-camera"></i> Capture
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">Supported formats: JPG, PNG, WEBP (Max 5MB)</div>
                        <div id="imagePreview" class="mt-2 text-center" style="display: none;">
                            <img id="previewImage" src="#" alt="Preview" class="img-thumbnail" style="max-height: 150px;">
                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeImageBtn">
                                <i class="bi bi-trash"></i> Remove Image
                            </button>
                        </div>
                    </div>
                </form>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" id="saveMeasurementsBtn">
                        <i class="bi bi-save"></i> Save Measurements
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal (Removed as requested) -->

<!-- Search Customer Modal -->
<div class="modal fade" id="searchCustomerModal" tabindex="-1" aria-labelledby="searchCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchCustomerModalLabel">Find Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="searchPhone" class="form-label">Enter Phone Number</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                        <input type="tel" class="form-control" id="searchPhone" placeholder="e.g., 9876543210" pattern="[0-9]{10}" required>
                        <button class="btn btn-primary" type="button" id="searchCustomerBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="searchSpinner"></span>
                            <span id="searchBtnText">Search</span>
                        </button>
                    </div>
                    <div class="form-text">Enter the 10-digit phone number to search</div>
                </div>
                
                <div id="searchResults" class="mt-3">
                    <!-- Search results will be displayed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary me-2" id="newOrderBtn" style="display: none;">
                    <i class="bi bi-plus-circle"></i> New Order
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Amount Modal -->
<div class="modal fade" id="updateAmountModal" tabindex="-1" aria-labelledby="updateAmountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateAmountModalLabel">Update Customer Amount</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateAmountForm">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount (â‚¹)</label>
                        <input type="number" step="0.01" class="form-control" id="amount" required>
                        <div class="invalid-feedback">Please enter a valid amount</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAmountBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Audio Recording Modal -->
<div class="modal fade" id="audioModal" tabindex="-1" aria-labelledby="audioModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="audioModalLabel">Record Audio Notes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div id="audioVisualizer" class="mb-2" style="height: 50px; border: 1px solid #dee2e6; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                        <span class="text-muted">Audio visualizer will appear here</span>
                    </div>
                    <div id="audioControls" class="mb-3">
                        <button id="startRecording" class="btn btn-danger btn-sm me-2" disabled>
                            <i class="bi bi-record-circle"></i> Start Recording
                        </button>
                        <button id="stopRecording" class="btn btn-secondary btn-sm me-2" disabled>
                            <i class="bi bi-stop-circle"></i> Stop
                        </button>
                        <button id="playRecording" class="btn btn-success btn-sm" disabled>
                            <i class="bi bi-play-circle"></i> Play
                        </button>
                    </div>
                    <audio id="audioPlayback" class="w-100" controls style="display: none;"></audio>
                    <div id="recordingStatus" class="small text-muted">Ready to record</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="saveAudioBtn" class="btn btn-primary" disabled>Save Recording</button>
            </div>
        </div>
    </div>
</div>

<!-- Notes Modal -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notesModalLabel">Measurement Notes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <textarea class="form-control" id="measurementNotes" rows="8" placeholder="Add notes about this measurement..."></textarea>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div id="saveStatus" class="small"></div>
                    <div>
                        <button type="button" class="btn btn-secondary btn-sm me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary btn-sm" id="saveNotesBtn">Save Notes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/recordrtc@5.6.2/RecordRTC.min.js"></script>
<script>
    // Audio recording variables
    let mediaRecorder;
    let audioChunks = [];
    let currentAudioUrl = '';
    let currentMeasurementId = null;
    let currentNotes = '';
    
    // Initialize modals
    const notesModal = new bootstrap.Modal(document.getElementById('notesModal'));
    const audioModal = new bootstrap.Modal(document.getElementById('audioModal'));
    const notesTextarea = document.getElementById('measurementNotes');
    const saveStatus = document.getElementById('saveStatus');
    
    // Audio visualization function
    function visualize(stream) {
        if (!stream) return;
        
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const microphone = audioContext.createMediaStreamSource(stream);
        const javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
        
        analyser.smoothingTimeConstant = 0.8;
        analyser.fftSize = 1024;
        
        microphone.connect(analyser);
        analyser.connect(javascriptNode);
        javascriptNode.connect(audioContext.destination);
        
        const canvas = document.createElement('canvas');
        canvas.width = document.getElementById('audioVisualizer').offsetWidth;
        canvas.height = document.getElementById('audioVisualizer').offsetHeight;
        const canvasCtx = canvas.getContext('2d');
        document.getElementById('audioVisualizer').innerHTML = '';
        document.getElementById('audioVisualizer').appendChild(canvas);
        
        javascriptNode.onaudioprocess = function() {
            const array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(array);
            
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw the frequency domain chart
            canvasCtx.fillStyle = '#f8f9fa';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / 64) * 2.5;
            let barHeight;
            let x = 0;
            
            for (let i = 0; i < 64; i++) {
                barHeight = (array[i] / 255) * canvas.height;
                canvasCtx.fillStyle = '#0d6efd';
                canvasCtx.fillRect(x, canvas.height - barHeight, barWidth - 2, barHeight);
                x += barWidth + 1;
            }
        };
    }
    
    // Save notes to server
    async function saveNotes() {
        if (!currentMeasurementId) {
            console.error('No measurement ID available');
            return;
        }
        
        const notes = notesTextarea.value;
        saveStatus.textContent = 'Saving...';
        saveStatus.className = 'text-warning small';
        
        try {
            console.log('Saving notes for measurement ID:', currentMeasurementId);
            const response = await fetch(`/measurement/${currentMeasurementId}/update_notes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'  // Add this header
                },
                body: JSON.stringify({ notes: notes })
            });
            
            console.log('Response status:', response.status);
            const responseText = await response.text();
            console.log('Response text:', responseText);
            
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                console.error('Failed to parse JSON response:', e);
                throw new Error('Invalid server response');
            }
            
            if (data && data.success) {
                console.log('Notes saved successfully');
                saveStatus.textContent = 'Notes saved successfully';
                saveStatus.className = 'text-success small';
                currentNotes = notes;
                
                // Hide status after 2 seconds
                setTimeout(() => {
                    if (saveStatus.textContent === 'Notes saved successfully') {
                        saveStatus.textContent = '';
                    }
                }, 2000);
            } else {
                const errorMsg = data && data.error ? data.error : 'Failed to save notes';
                console.error('Server error:', errorMsg);
                throw new Error(errorMsg);
            }
        } catch (error) {
            console.error('Error saving notes:', error);
            saveStatus.textContent = 'Error: ' + error.message;
            saveStatus.className = 'text-danger small';
        }
    }
    
    // Event listeners for notes and audio buttons
    document.addEventListener('click', function(e) {
        // Handle notes button click
        if (e.target.closest('.view-notes') || e.target.closest('#customerNotesBtn')) {
            const button = e.target.closest('.view-notes') || e.target.closest('#customerNotesBtn');
            currentMeasurementId = button.getAttribute('data-id') || document.getElementById('customer_id').value;
            const notes = button.getAttribute('data-notes') || currentNotes || '';
            
            // Update the notes textarea and show the modal
            notesTextarea.value = notes;
            saveStatus.textContent = '';
            notesModal.show();
        }
        
        // Handle audio button click
        if (e.target.closest('.record-audio') || e.target.closest('#customerAudioBtn')) {
            const button = e.target.closest('.record-audio') || e.target.closest('#customerAudioBtn');
            currentMeasurementId = button.getAttribute('data-id') || document.getElementById('customer_id').value;
            const audioUrl = button.getAttribute('data-audio-url') || '';
            
            // Reset audio UI
            document.getElementById('audioPlayback').style.display = 'none';
            document.getElementById('startRecording').disabled = false;
            document.getElementById('stopRecording').disabled = true;
            document.getElementById('playRecording').disabled = true;
            document.getElementById('saveAudioBtn').disabled = true;
            
            // If there's an existing audio, show it
            if (audioUrl) {
                const audioPlayback = document.getElementById('audioPlayback');
                audioPlayback.src = audioUrl;
                audioPlayback.style.display = 'block';
                document.getElementById('playRecording').disabled = false;
            }
            
            audioModal.show();
        }
    });
    
    // Save notes button
    document.getElementById('saveNotesBtn').addEventListener('click', saveNotes);
    
    // Handle audio recording
    document.getElementById('startRecording').addEventListener('click', async () => {
        try {
            audioChunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            
            // Visualize the audio
            visualize(stream);
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                currentAudioUrl = URL.createObjectURL(audioBlob);
                
                const audioPlayback = document.getElementById('audioPlayback');
                audioPlayback.src = currentAudioUrl;
                audioPlayback.style.display = 'block';
                
                document.getElementById('playRecording').disabled = false;
                document.getElementById('saveAudioBtn').disabled = false;
                document.getElementById('recordingStatus').textContent = 'Recording stopped. Ready to save.';
                
                // Stop all tracks in the stream
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            document.getElementById('startRecording').disabled = true;
            document.getElementById('stopRecording').disabled = false;
            document.getElementById('recordingStatus').textContent = 'Recording... Click Stop when finished.';
            
        } catch (error) {
            console.error('Error accessing microphone:', error);
            alert('Could not access microphone. Please ensure you have granted microphone permissions.');
        }
    });
    
    // Stop recording button
    document.getElementById('stopRecording').addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            document.getElementById('startRecording').disabled = false;
            document.getElementById('stopRecording').disabled = true;
        }
    });
    
    // Play recording button
    document.getElementById('playRecording').addEventListener('click', () => {
        const audioPlayback = document.getElementById('audioPlayback');
        if (audioPlayback.paused) {
            audioPlayback.play();
        } else {
            audioPlayback.pause();
            audioPlayback.currentTime = 0;
        }
    });
    
    // Save audio button
    document.getElementById('saveAudioBtn').addEventListener('click', async () => {
        if (!currentAudioUrl || !currentMeasurementId) return;
        
        const audioBlob = await fetch(currentAudioUrl).then(r => r.blob());
        const formData = new FormData();
        formData.append('audio', audioBlob, `recording-${currentMeasurementId}.wav`);
        
        try {
            document.getElementById('saveAudioBtn').disabled = true;
            document.getElementById('recordingStatus').textContent = 'Saving audio...';
            
            const response = await fetch(`/measurement/${currentMeasurementId}/audio`, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Failed to save audio');
            }
            
            const data = await response.json();
            document.getElementById('recordingStatus').textContent = 'Audio saved successfully!';
            
            // Update the audio URL in the button
            const audioBtn = document.querySelector(`.record-audio[data-id="${currentMeasurementId}"]`);
            if (audioBtn) {
                audioBtn.setAttribute('data-audio-url', data.audio_url);
            }
            
            // Hide the modal after a short delay
            setTimeout(() => {
                audioModal.hide();
            }, 1500);
            
        } catch (error) {
            console.error('Error saving audio:', error);
            document.getElementById('recordingStatus').textContent = 'Error saving audio. Please try again.';
            document.getElementById('saveAudioBtn').disabled = false;
        }
    });
    
    // Sample patterns data - in a real app, this would come from your backend
    const samplePatterns = [
        { id: 1, name: 'Classic T-Shirt', category: 'shirt', image: 'https://via.placeholder.com/300x400?text=T-Shirt+Pattern', description: 'Basic t-shirt pattern with standard fit' },
        { id: 2, name: 'Slim Fit Jeans', category: 'pant', image: 'https://via.placeholder.com/300x400?text=Jeans+Pattern', description: 'Slim fit jeans pattern with standard pockets' },
        { id: 3, name: 'Summer Dress', category: 'dress', image: 'https://via.placeholder.com/300x400?text=Summer+Dress', description: 'Light summer dress with A-line silhouette' },
        { id: 4, name: 'Pencil Skirt', category: 'skirt', image: 'https://via.placeholder.com/300x400?text=Pencil+Skirt', description: 'Fitted pencil skirt pattern' },
        { id: 5, name: 'Denim Jacket', category: 'jacket', image: 'https://via.placeholder.com/300x400?text=Denim+Jacket', description: 'Classic denim jacket pattern' },
    ];
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize UI elements
        const patternGridView = document.getElementById('patternGridView');
        const patternPreview = document.getElementById('patternPreview');
        const patternCategories = document.querySelectorAll('.pattern-category');
        const showAllPatternsBtn = document.getElementById('showAllPatterns');
        const toggleMeasurementsBtn = document.getElementById('toggleMeasurements');
        const measurementsCollapse = document.getElementById('measurementsCollapse');
        
        // Toggle between grid view and single pattern view
        function showPatternGrid() {
            patternGridView.classList.remove('d-none');
            patternPreview.classList.add('d-none');
            loadPatterns('all');
        }
        
        function showPatternPreview(patternId = null) {
            patternGridView.classList.add('d-none');
            patternPreview.classList.remove('d-none');
            
            if (patternId) {
                // Load specific pattern
                const pattern = samplePatterns.find(p => p.id === patternId);
                if (pattern) {
                    // In a real app, you would load the actual pattern data
                    document.getElementById('patternContainer').innerHTML = 
                        `<img src="${pattern.image}" class="img-fluid" alt="${pattern.name}">
                         <h4 class="mt-3">${pattern.name}</h4>
                         <p class="text-muted">${pattern.description}</p>`;
                    document.getElementById('patternActions').classList.remove('d-none');
                }
            } else {
                // Show empty state
                document.getElementById('patternContainer').innerHTML = `
                    <div class="text-muted p-5">
                        <i class="bi bi-rulers" style="font-size: 3rem;"></i>
                        <p class="mt-3">Enter your measurements and click 'Generate Pattern' to create your custom pattern</p>
                    </div>`;
                document.getElementById('patternActions').classList.add('d-none');
            }
        }
        
        // Load patterns into the grid
        function loadPatterns(category) {
            const container = document.getElementById('patternsContainer');
            container.innerHTML = '';
            
            const patterns = category === 'all' 
                ? samplePatterns 
                : samplePatterns.filter(p => p.category === category);
            
            if (patterns.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.5;"></i>
                        <p class="mt-3 text-muted">No patterns found in this category</p>
                    </div>`;
                return;
            }
            
            patterns.forEach(pattern => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-4';
                col.innerHTML = `
                    <div class="card h-100 pattern-card">
                        <img src="${pattern.image}" class="card-img-top" alt="${pattern.name}">
                        <div class="card-body">
                            <h5 class="card-title">${pattern.name}</h5>
                            <p class="card-text text-muted small">${pattern.description}</p>
                        </div>
                        <div class="card-footer bg-transparent border-top-0">
                            <button class="btn btn-sm btn-outline-primary w-100 use-pattern" 
                                    data-pattern-id="${pattern.id}">
                                <i class="bi bi-magic"></i> Use This Pattern
                            </button>
                        </div>
                    </div>`;
                container.appendChild(col);
            });
            
            // Add event listeners to the new buttons
            document.querySelectorAll('.use-pattern').forEach(btn => {
                btn.addEventListener('click', function() {
                    const patternId = parseInt(this.getAttribute('data-pattern-id'));
                    showPatternPreview(patternId);
                });
            });
        }
        
        // Event Listeners
        patternCategories.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.pattern-category').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                loadPatterns(this.getAttribute('data-category'));
                // Show grid view
                showPatternGrid();
            });
        });
        
        // My Measurements / All Measurements button click handler
        const myMeasurementsBtn = document.getElementById('myMeasurementsBtn');
        const allMeasurementsBtn = document.getElementById('allMeasurementsBtn');
        
        if (myMeasurementsBtn) {
            myMeasurementsBtn.addEventListener('click', function() {
                // Redirect to my-measurements page
                window.location.href = '{{ url_for("my_measurements") }}';
            });
        }
        
        if (allMeasurementsBtn) {
            allMeasurementsBtn.addEventListener('click', function() {
                // Redirect to admin measurements page or show all measurements
                window.location.href = '{{ url_for("admin_measurements") }}';
            });
        }
        
        // Toggle measurements section
        let measurementsVisible = true;
        toggleMeasurementsBtn.addEventListener('click', function() {
            measurementsVisible = !measurementsVisible;
            this.innerHTML = measurementsVisible ? 
                '<i class="bi bi-chevron-up"></i>' : 
                '<i class="bi bi-chevron-down"></i>';
        });
        
        // Function to update measurement fields based on selected category
        function updateMeasurementFields(category) {
            console.log('Updating measurement fields for category:', category);
            
            // Hide all measurement sections first
            document.querySelectorAll('.measurement-category').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show the selected category's measurement section
            if (category) {
                const selectedSection = document.getElementById(`${category}Measurements`);
                if (selectedSection) {
                    selectedSection.style.display = 'block';
                }
                
                // Clear all measurement inputs for the selected category
                if (selectedSection) {
                    selectedSection.querySelectorAll('input[type="number"]').forEach(input => {
                        input.value = '';
                    });
                }
            }
            
            // Update the hidden category input
            const categoryInput = document.getElementById('category');
            if (categoryInput) {
                categoryInput.value = category || '';
                console.log('Category input value set to:', categoryInput.value);
            } else {
                console.error('Category input element not found!');
            }
        }
        
        // Handle category dropdown selection
        const categoryDropdown = document.getElementById('categoryDropdown');
        const categoryItems = document.querySelectorAll('.pattern-category');
        
        categoryItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const category = this.getAttribute('data-category');
                const categoryName = this.textContent.trim();
                
                // Update dropdown button text
                categoryDropdown.innerHTML = categoryName;
                
                // Update active state
                categoryItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // Update measurement fields based on category
                updateMeasurementFields(category);
                
                // Load patterns for the selected category
                loadPatterns(category);
            });
        });
        
        // Initialize with first category selected
        if (categoryItems.length > 0) {
            const firstCategory = categoryItems[0].getAttribute('data-category');
            updateMeasurementFields(firstCategory);
        }
        
        // Initialize
        showPatternPreview();
        
        // Load saved measurements
        loadSavedMeasurements();
        
        // Close the pattern grid when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#patternGridView') && !e.target.closest('#showAllPatterns')) {
                showPatternPreview();
            }
        });
        
        // Handle form submission for pattern generation
        document.getElementById('measurementForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generatePattern(false);
        });
        
        // Handle save measurements button
        document.getElementById('saveMeasurementsBtn').addEventListener('click', function() {
            generatePattern(true);
        });
        
        // Handle download PDF button
        document.getElementById('downloadPdfBtn').addEventListener('click', function() {
            // TODO: Implement PDF download functionality
            alert('PDF download will be implemented in the next update');
        });
    });
    
    // Load saved measurements from the server
    function loadSavedMeasurements() {
        fetch('/api/measurements')
            .then(response => response.json())
            .then(measurements => {
                const container = document.getElementById('savedMeasurementsList');
                
                if (measurements.length === 0) {
                    container.innerHTML = '<p class="text-muted">No saved measurements yet.</p>';
                    return;
                }
                
                container.innerHTML = '<div class="list-group">' + 
                    measurements.map(m => {
                        const hasImage = m.image_path ? 'has-image' : '';
                        const imagePreview = m.image_path ? 
                            `<div class="measurement-image-preview" style="background-image: url(/${m.image_path})"></div>` : 
                            '';
                        
                        return `
                        <div class="list-group-item list-group-item-action ${hasImage}" 
                             onclick="loadMeasurement(${m.id})">
                            ${imagePreview}
                            <div class="measurement-details">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Measurement #${m.id}</h6>
                                    <small>${new Date(m.created_at).toLocaleString()}</small>
                                </div>
                                <small class="text-muted">Bust: ${m.measurements.bust} in â€¢ Waist: ${m.measurements.waist} in</small>
                            </div>
                        </div>`;
                    }).join('') + '</div>';
            })
            .catch(error => {
                console.error('Error loading measurements:', error);
                document.getElementById('savedMeasurementsList').innerHTML = 
                    '<div class="alert alert-danger">Error loading measurements. Please try again.</div>';
            });
    }
    
    // Load a specific measurement into the form
    function loadMeasurement(measurementId) {
        fetch(`/api/measurements/${measurementId}`)
            .then(response => response.json())
            .then(measurement => {
                // Set the category first
                const category = measurement.category || 'blouse';
                const categoryDropdown = document.querySelector(`.pattern-category[data-category="${category}"]`);
                if (categoryDropdown) {
                    categoryDropdown.click(); // This will update the form fields
                }
                
                // Update common fields
                document.getElementById('cloth_length').value = measurement.cloth_length || '';
                document.getElementById('cloth_width').value = measurement.cloth_width || '';
                
                // Update fields based on category
                switch(category) {
                    case 'blouse':
                        if (measurement.length) document.getElementById('blouse_length').value = measurement.length;
                        if (measurement.across_shoulder) document.getElementById('blouse_across_shoulder').value = measurement.across_shoulder;
                        if (measurement.upper_chest) document.getElementById('blouse_upper_chest').value = measurement.upper_chest;
                        if (measurement.chest) document.getElementById('blouse_chest').value = measurement.chest;
                        if (measurement.waist) document.getElementById('blouse_waist').value = measurement.waist;
                        if (measurement.shoulder_apex) document.getElementById('blouse_shoulder_apex').value = measurement.shoulder_apex;
                        if (measurement.front_neck_depth) document.getElementById('blouse_front_neck').value = measurement.front_neck_depth;
                        if (measurement.back_neck_depth) document.getElementById('blouse_back_neck').value = measurement.back_neck_depth;
                        if (measurement.sleeve_length) document.getElementById('blouse_sleeve_length').value = measurement.sleeve_length;
                        if (measurement.armhole) document.getElementById('blouse_armhole').value = measurement.armhole;
                        if (measurement.biceps) document.getElementById('blouse_biceps').value = measurement.biceps;
                        if (measurement.sleeve_cuff) document.getElementById('blouse_sleeve_cuff').value = measurement.sleeve_cuff;
                        break;
                        
                    case 'kurti':
                        if (measurement.length) document.getElementById('kurti_length').value = measurement.length;
                        if (measurement.across_shoulder) document.getElementById('kurti_across_shoulder').value = measurement.across_shoulder;
                        if (measurement.upper_chest) document.getElementById('kurti_upper_chest').value = measurement.upper_chest;
                        if (measurement.chest) document.getElementById('kurti_chest').value = measurement.chest;
                        if (measurement.waist) document.getElementById('kurti_waist').value = measurement.waist;
                        if (measurement.hip) document.getElementById('kurti_hip').value = measurement.hip;
                        if (measurement.front_neck_depth) document.getElementById('kurti_front_neck').value = measurement.front_neck_depth;
                        if (measurement.back_neck_depth) document.getElementById('kurti_back_neck').value = measurement.back_neck_depth;
                        if (measurement.sleeve_length) document.getElementById('kurti_sleeve_length').value = measurement.sleeve_length;
                        if (measurement.armhole) document.getElementById('kurti_armhole').value = measurement.armhole;
                        if (measurement.biceps) document.getElementById('kurti_biceps').value = measurement.biceps;
                        if (measurement.sleeve_cuff) document.getElementById('kurti_sleeve_cuff').value = measurement.sleeve_cuff;
                        break;
                        
                    case 'lehenga':
                        if (measurement.waist_floor) document.getElementById('lehenga_waist_floor').value = measurement.waist_floor;
                        if (measurement.belt) document.getElementById('lehenga_belt').value = measurement.belt;
                        if (measurement.hip) document.getElementById('lehenga_hip').value = measurement.hip;
                        break;
                        
                    case 'pant':
                        if (measurement.waist_ankle) document.getElementById('pant_waist_ankle').value = measurement.waist_ankle;
                        if (measurement.waist_floor) document.getElementById('pant_waist_floor').value = measurement.waist_floor;
                        if (measurement.belt) document.getElementById('pant_belt').value = measurement.belt;
                        if (measurement.hip) document.getElementById('pant_hip').value = measurement.hip;
                        if (measurement.thigh) document.getElementById('pant_thigh').value = measurement.thigh;
                        if (measurement.ankle) document.getElementById('pant_ankle').value = measurement.ankle;
                        break;
                }
                
                // Update image preview if exists
                if (measurement.image_path) {
                    const imagePreview = document.getElementById('imagePreview');
                    const imagePreviewImg = document.getElementById('imagePreviewImg');
                    const imageFileName = document.getElementById('imageFileName');
                    
                    // Remove any existing image data
                    if (imageFileName) {
                        imageFileName.value = '';
                    }
                    
                    // Show the image preview
                    imagePreviewImg.src = '/' + measurement.image_path;
                    imagePreview.style.display = 'block';
                }
                
                // Show success message
                const successMessage = document.getElementById('successMessage');
                successMessage.style.display = 'block';
                
                // Auto-hide success message after 5 seconds
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                console.error('Error loading measurement:', error);
                showAlert('Error loading measurement: ' + error.message, 'danger');
            });
    }
    
    // Save measurements to the server
    function saveMeasurements() {
        // Get the customer ID from the hidden input or data attribute
        const customerId = document.querySelector('input[name="customer_id"]')?.value || 
                          document.getElementById('customerDetailsSection')?.dataset.customerId;
        
        if (!customerId) {
            showAlert('No customer selected. Please select a customer first.', 'error');
            return;
        }
        
        // Show loading state
        const saveBtn = document.getElementById('saveMeasurementsBtn');
        const originalBtnText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
        
        // Collect all form data
        const formData = new FormData();
        const clothImage = document.getElementById('cloth_image');
        const category = document.getElementById('category')?.value || 'blouse';
        
        // Add customer ID to form data
        formData.append('customer_id', customerId);
        
        console.log('Saving measurements for category:', category);
        console.log('Category input value:', document.getElementById('category').value);
        
        // Add customer details to form data
        const customerData = {
            name: document.getElementById('displayCustomerName')?.textContent || '',
            phone: document.getElementById('displayCustomerPhone')?.textContent || '',
            email: document.getElementById('displayCustomerEmail')?.textContent || '',
            address: document.getElementById('displayCustomerAddress')?.textContent || ''
        };
        
        // Add customer data to form data with customer_ prefix
        Object.entries(customerData).forEach(([key, value]) => {
            if (value) formData.append(`customer_${key}`, value);
        });
        
        // Add category only once
        formData.set('category', category);
        
        // Add order and delivery dates if they exist
        const orderDate = document.getElementById('orderDate')?.value;
        const deliveryDate = document.getElementById('deliveryDate')?.value;
        
        // Add amount and advance amount to form data
        const amount = document.getElementById('displayCustomerAmount')?.textContent;
        const advanceAmount = document.getElementById('advanceAmount')?.value;
        
        if (amount) {
            formData.append('amount', amount);
        }
        if (advanceAmount) {
            formData.append('advance_amount', advanceAmount);
        }
        
        if (orderDate) {
            formData.append('order_date', orderDate);
        }
        
        if (deliveryDate) {
            formData.append('delivery_date', deliveryDate);
        }
        
        // Add image if available
        if (clothImage && clothImage.files.length > 0) {
            formData.set('cloth_image', clothImage.files[0]);
        }
        
        // Get all measurement inputs from the form
        const measurementInputs = document.querySelectorAll('input[type="number"]');
        
        // Process each input field
        measurementInputs.forEach(input => {
            const fieldName = input.name;
            // Remove category prefix if present (e.g., 'blouse_length' -> 'length')
            const baseFieldName = fieldName.includes('_') ? fieldName.split('_').slice(1).join('_') : fieldName;
            
            if (input.value) {
                console.log(`Saving field: ${baseFieldName} = ${input.value}`);
                formData.append(baseFieldName, input.value);
            }
        });
        
        // Log form data before sending
        console.log('Form data being sent:');
        for (let pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }
        
        // Submit the form data to the backend
        fetch('/api/save_measurements', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { 
                    throw new Error(err.message || 'Failed to save measurements'); 
                });
            }
            return response.json();
        })
        .then(data => {
            // Re-enable the button
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnText;
            
            // Show success message and redirect
            const successMessage = document.getElementById('successMessage');
            if (successMessage) {
                successMessage.textContent = 'Measurements saved successfully! Redirecting to measurements page...';
                successMessage.style.display = 'block';
                
                // Redirect to customer-measurements page after a short delay
                setTimeout(() => {
                    window.location.href = '/customer-measurements';
                }, 1500);
            }
            
            // Reload measurements list if the function exists
            if (typeof loadSavedMeasurements === 'function') {
                loadSavedMeasurements();
            }
            
            console.log('Measurements saved:', data);
            
            // Enable notes and audio buttons
            document.getElementById('customerNotesBtn').disabled = false;
            document.getElementById('customerAudioBtn').disabled = false;
            document.getElementById('startRecording').disabled = false;
        })
        .catch(error => {
            console.error('Error saving measurements:', error);
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnText;
            
            // Show error message
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.textContent = error.message || 'Failed to save measurements';
                errorMessage.style.display = 'block';
                
                // Auto-hide error message after 5 seconds
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
        });
    }
    
    // Show alert message
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        alertDiv.style.zIndex = '1100';
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alertDiv);
            bsAlert.close();
        }, 5000);
    }

    // Camera functionality
    document.addEventListener('DOMContentLoaded', function() {
        const cameraBtn = document.getElementById('cameraBtn');
        const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const imageFileName = document.getElementById('imageFileName');
        const fileInput = document.getElementById('cloth_image');
        const previewImage = document.getElementById('previewImage');
        const imagePreview = document.getElementById('imagePreview');
        const removeImageBtn = document.getElementById('removeImageBtn');
        let stream = null;

        // Open camera when camera button is clicked
        cameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment' 
                    } 
                });
                video.srcObject = stream;
                cameraModal.show();
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('Could not access the camera. Please ensure you have granted camera permissions.');
            }
        });

        // Capture image from camera
        captureBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to blob and create a file
            canvas.toBlob((blob) => {
                const fileName = `capture_${new Date().getTime()}.jpg`;
                const file = new File([blob], fileName, { type: 'image/jpeg' });
                
                // Create a data transfer object to simulate file input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                // Update the UI
                imageFileName.value = fileName;
                previewImage.src = URL.createObjectURL(file);
                imagePreview.style.display = 'block';
                
                // Close the modal and stop the camera
                cameraModal.hide();
                stopCamera();
            }, 'image/jpeg', 0.9);
        });

        // Stop camera when modal is closed
        document.getElementById('cameraModal').addEventListener('hidden.bs.modal', () => {
            stopCamera();
        });

        // Handle remove image button
        if (removeImageBtn) {
            removeImageBtn.addEventListener('click', () => {
                fileInput.value = '';
                imageFileName.value = '';
                imagePreview.style.display = 'none';
                previewImage.src = '#';
            });
        }

        // Stop camera function
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                stream = null;
            }
        }
    });

    // Form submission handling
    document.addEventListener('DOMContentLoaded', function() {
        // Get all necessary DOM elements
        const categoryDropdown = document.getElementById('categoryDropdown');
        const measurementSection = document.getElementById('measurementSection');
        const customerSelectionScreen = document.getElementById('customerSelectionScreen');
        const newCustomerForm = document.getElementById('newCustomerForm');
        const newCustomerBtn = document.getElementById('newCustomerBtn');
        const existingCustomerBtn = document.getElementById('existingCustomerBtn');
        const backToCustomerSelection = document.getElementById('backToCustomerSelection');
        const customerInfoForm = document.getElementById('customerInfoForm');
        const categoryItems = document.querySelectorAll('.pattern-category');
        
        // Initialize UI state
        if (categoryDropdown) {
            categoryDropdown.disabled = true;
            categoryDropdown.classList.add('disabled');
        }
        
        if (measurementSection) {
            measurementSection.style.display = 'none';
        }
        
        // Handle My Measurements button click
        const myMeasurementsBtn = document.getElementById('myMeasurementsBtn');
        if (myMeasurementsBtn) {
            myMeasurementsBtn.addEventListener('click', function() {
                window.location.href = '{{ url_for("customer_measurements") }}';
            });
        }
        
        // Lock category selection initially
        categoryDropdown.classList.add('disabled');
        categoryItems.forEach(item => {
            item.classList.add('disabled');
            item.style.pointerEvents = 'none';
            item.style.opacity = '0.6';
        });
        
        // Show new customer form
        newCustomerBtn.addEventListener('click', function() {
            customerSelectionScreen.style.display = 'none';
            newCustomerForm.style.display = 'block';
        });
        
        // Back to customer selection
        backToCustomerSelection.addEventListener('click', function() {
            // Show customer selection screen
            customerSelectionScreen.style.display = 'block';
            
            // Hide other sections
            newCustomerForm.style.display = 'none';
            document.getElementById('customerDetailsSection').style.display = 'none';
            document.getElementById('measurementSection').style.display = 'none';
            
            // Reset the form
            customerInfoForm.reset();
            
            // Clear customer details display
            document.getElementById('displayCustomerName').textContent = '';
            document.getElementById('displayCustomerEmail').textContent = '';
            document.getElementById('displayCustomerPhone').textContent = '';
            document.getElementById('displayCustomerAddress').textContent = '';
            
            // Clear customer ID
            document.getElementById('customer_id').value = '';
            
            // Disable category dropdown and reset it
            const categoryDropdown = document.getElementById('categoryDropdown');
            if (categoryDropdown) {
                categoryDropdown.disabled = true;
                categoryDropdown.classList.add('disabled');
                categoryDropdown.textContent = 'Select Category';
            }
            
            // Reset category selection
            const categoryItems = document.querySelectorAll('.pattern-category');
            categoryItems.forEach(item => {
                item.classList.remove('active');
                item.style.pointerEvents = 'none';
                item.style.opacity = '0.6';
            });
            
            // Reset the hidden category input
            document.getElementById('category').value = '';
            
            // Clear all measurement inputs
            document.querySelectorAll('.measurement-category input[type="number"]').forEach(input => {
                input.value = '';
            });
            
            // Hide any success messages
            const successMessage = document.getElementById('successMessage');
            if (successMessage) {
                successMessage.style.display = 'none';
            }
        });
        
        // Handle customer form submission
        document.getElementById('customerInfoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const customerData = {
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value
            };
            
            try {
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
                
                // Send data to server
                const response = await fetch('{{ url_for("add_customer") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(customerData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Store the customer ID in the hidden field
                    document.getElementById('customer_id').value = result.customer_id;
                    
                    // Update the customer details section
                    document.getElementById('displayCustomerName').textContent = customerData.name;
                    document.getElementById('displayCustomerEmail').textContent = customerData.email || 'Not provided';
                    document.getElementById('displayCustomerPhone').textContent = customerData.phone || 'Not provided';
                    document.getElementById('displayCustomerAddress').textContent = customerData.address || 'Not provided';
                    document.getElementById('displayCustomerAmount').textContent = customerData.amount ? parseFloat(customerData.amount).toFixed(2) : '0.00';
                    
                    // Show the measurement section and hide other sections
                    document.getElementById('customerSelectionScreen').style.display = 'none';
                    newCustomerForm.style.display = 'none';
                    document.getElementById('customerDetailsSection').style.display = 'block';
                    document.getElementById('measurementSection').style.display = 'block';
                    
                    // Enable the category dropdown and unlock category selection
                    const categoryDropdown = document.getElementById('categoryDropdown');
                    const patternCategories = document.querySelectorAll('.pattern-category');
                    
                    if (categoryDropdown) {
                        // Enable the dropdown button
                        categoryDropdown.disabled = false;
                        categoryDropdown.classList.remove('disabled');
                    }
                    
                    // Enable all category items
                    patternCategories.forEach(item => {
                        item.style.pointerEvents = 'auto';
                        item.style.opacity = '1';
                    });
                    
                    // Show success message
                    showAlert('Customer saved successfully! Category selection is now available.', 'success');
                } else {
                    throw new Error(result.error || 'Failed to save customer');
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                showAlert(error.message || 'An error occurred while saving the customer.', 'danger');
            } finally {
                // Reset button state
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save Customer & Continue';
            }
        });
        
        // Show existing customers modal
        existingCustomerBtn.addEventListener('click', async function() {
            try {
                // Fetch customers from the server
                const response = await fetch('/customers/json');
                const customers = await response.json();
                
                const customerList = document.getElementById('customerList');
                customerList.innerHTML = ''; // Clear previous results
                
                if (customers.length === 0) {
                    customerList.innerHTML = '<div class="text-center py-3">No customers found. Please add a new customer.</div>';
                } else {
                    customers.forEach(customer => {
                        const customerItem = document.createElement('div');
                        customerItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                        customerItem.innerHTML = `
                            <div>
                                <h6 class="mb-1">${customer.name}</h6>
                                <small class="text-muted">${customer.phone || 'No phone'}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary select-customer" data-id="${customer.id}" data-name="${customer.name}" data-email="${customer.email || ''}" data-phone="${customer.phone || ''}" data-address="${customer.address || ''}">
                                Select
                            </button>
                        `;
                        customerList.appendChild(customerItem);
                    });
                }
                
                // Show the modal
                const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));
                customerModal.show();
                
            } catch (error) {
                console.error('Error loading customers:', error);
                showAlert('Error loading customers. Please try again.', 'error');
            }
        });
        
        // Handle customer selection from the modal
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('select-customer')) {
                const customerId = e.target.getAttribute('data-id');
                const customerName = e.target.getAttribute('data-name');
                const customerEmail = e.target.getAttribute('data-email');
                const customerPhone = e.target.getAttribute('data-phone');
                const customerAddress = e.target.getAttribute('data-address');
                
                // Set the customer ID in the hidden field
                document.getElementById('customer_id').value = customerId;
                
                // Update the customer details display
                document.getElementById('displayCustomerName').textContent = customerName;
                document.getElementById('displayCustomerEmail').textContent = customerEmail || 'Not provided';
                document.getElementById('displayCustomerPhone').textContent = customerPhone || 'Not provided';
                document.getElementById('displayCustomerAddress').textContent = customerAddress || 'Not provided';
                document.getElementById('displayCustomerAmount').textContent = customer.amount ? parseFloat(customer.amount).toFixed(2) : '0.00';
                
                // Hide the modal and show the measurement form
                const customerModal = bootstrap.Modal.getInstance(document.getElementById('customerModal'));
                customerModal.hide();
                
                // Show the measurement form and hide customer selection
                document.getElementById('customerSelectionScreen').style.display = 'none';
                document.getElementById('customerDetailsSection').style.display = 'block';
                document.getElementById('measurementForm').style.display = 'block';
            }
        });
        // Handle Edit Customer button
        document.getElementById('editCustomerBtn').addEventListener('click', function() {
            document.getElementById('customerDetailsSection').style.display = 'none';
            newCustomerForm.style.display = 'block';
        });

        // Handle Back to Customer Selection button
        const backToSelectionBtn = document.getElementById('backToSelectionBtn');
        if (backToSelectionBtn) {
            backToSelectionBtn.addEventListener('click', function() {
                // Hide the measurement form and show the customer selection screen
                document.getElementById('measurementForm').style.display = 'none';
                document.getElementById('customerSelectionScreen').style.display = 'block';
                
                // Reset the form
                document.getElementById('measurementForm').reset();
                
                // Reset any previews or additional UI elements if needed
                const previewImage = document.getElementById('previewImage');
                if (previewImage) {
                    previewImage.src = '#';
                    previewImage.style.display = 'none';
                }
                
                // Reset file input
                const clothImage = document.getElementById('cloth_image');
                if (clothImage) {
                    clothImage.value = '';
                }
                
                // Reset file name display
                const imageFileName = document.getElementById('imageFileName');
                if (imageFileName) {
                    imageFileName.textContent = 'No file chosen';
                }
            });
        }
        
        // Handle Save Measurements button
        const saveBtn = document.getElementById('saveMeasurementsBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                // First validate the form
                const form = document.getElementById('measurementForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                // If form is valid, save measurements
                saveMeasurements();
            });
        }
        
        // Image Upload Handling
        const clothImage = document.getElementById('cloth_image');
        const imageFileName = document.getElementById('imageFileName');
        const browseBtn = document.getElementById('browseBtn');
        const previewImage = document.getElementById('previewImage');
        const imagePreview = document.getElementById('imagePreview');
        const removeImageBtn = document.getElementById('removeImageBtn');

        // Trigger file input when browse button is clicked
        if (browseBtn) {
            browseBtn.addEventListener('click', () => {
                clothImage.click();
            });
        }

        // Handle file selection
        if (clothImage) {
            clothImage.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
                    if (!validTypes.includes(file.type)) {
                        alert('Please select a valid image file (JPG, PNG, or WEBP)');
                        resetImageInput();
                        return;
                    }

                    // Validate file size (5MB max)
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    if (file.size > maxSize) {
                        alert('Image size should not exceed 5MB');
                        resetImageInput();
                        return;
                    }

                    // Update file name display
                    imageFileName.value = file.name;

                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        imagePreview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        // Handle remove image button
        if (removeImageBtn) {
            removeImageBtn.addEventListener('click', resetImageInput);
        }

        // Reset image input and preview
        function resetImageInput() {
            if (clothImage) {
                clothImage.value = '';
            }
            if (imageFileName) {
                imageFileName.value = '';
            }
            if (previewImage) {
                previewImage.src = '#';
            }
            if (imagePreview) {
                imagePreview.style.display = 'none';
            }
        }
    });

    // Handle customer search
    const searchCustomerModal = new bootstrap.Modal(document.getElementById('searchCustomerModal'));
    const searchCustomerBtn = document.getElementById('existingCustomerBtn');
    const searchPhoneInput = document.getElementById('searchPhone');
    const searchCustomerSubmitBtn = document.getElementById('searchCustomerBtn');
    const searchSpinner = document.getElementById('searchSpinner');
    const searchBtnText = document.getElementById('searchBtnText');
    const searchResults = document.getElementById('searchResults');

    // Open search modal when clicking Find Customer button
    if (searchCustomerBtn) {
        searchCustomerBtn.addEventListener('click', function() {
            searchCustomerModal.show();
            // Clear previous results and input
            searchPhoneInput.value = '';
            searchResults.innerHTML = '';
            // Hide the New Order button by default
            document.getElementById('newOrderBtn').style.display = 'none';
        });
    }

    // Handle search form submission
    if (searchCustomerSubmitBtn) {
        searchCustomerSubmitBtn.addEventListener('click', searchCustomerByPhone);
        searchPhoneInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCustomerByPhone();
            }
        });
    }

    // Function to search customer by phone
    async function searchCustomerByPhone() {
        const phone = searchPhoneInput.value.trim();
        
        // Validate phone number
        if (!phone || !/^\d{10}$/.test(phone)) {
            searchResults.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Please enter a valid 10-digit phone number.
                </div>`;
            return;
        }

        // Show loading state
        searchSpinner.classList.remove('d-none');
        searchBtnText.textContent = 'Searching...';
        searchCustomerSubmitBtn.disabled = true;
        searchResults.innerHTML = '';

        try {
            const response = await fetch(`/customer/search?phone=${encodeURIComponent(phone)}`);
            const data = await response.json();

            if (response.ok) {
                if (data.customer) {
                    // Display customer information
                    displayCustomerInfo(data.customer);
                } else {
                    searchResults.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            No customer found with this phone number.
                        </div>`;
                }
            } else {
                throw new Error(data.message || 'Failed to search for customer');
            }
        } catch (error) {
            console.error('Error searching for customer:', error);
            searchResults.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-octagon-fill me-2"></i>
                    ${error.message || 'An error occurred while searching for the customer.'}
                </div>`;
        } finally {
            // Reset loading state
            searchSpinner.classList.add('d-none');
            searchBtnText.textContent = 'Search';
            searchCustomerSubmitBtn.disabled = false;
        }
    }

    // Function to display customer information
    function displayCustomerInfo(customer) {
        const amount = parseFloat(customer.amount) || 0;
        const advanceAmount = parseFloat(customer.advance_amount) || 0;
        let amountDue = amount - advanceAmount;
        let isPaid = amount > 0 && advanceAmount >= amount;
        
        // If there are multiple orders, calculate total due from orders
        if (customer.orders && customer.orders.length > 1) {
            amountDue = customer.orders.reduce((total, order) => {
                return total + (parseFloat(order.amount || 0) - parseFloat(order.advance_amount || 0));
            }, 0);
            isPaid = amountDue <= 0;
        }
        
        // Show the New Order button
        document.getElementById('newOrderBtn').style.display = 'inline-block';
        document.getElementById('newOrderBtn').onclick = async function() {
            // Show loading state
            const newOrderBtn = this;
            const originalText = newOrderBtn.innerHTML;
            newOrderBtn.disabled = true;
            newOrderBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating Order...';
            
            try {
                // Get amount and advance amount from the form or modal
                const amount = parseFloat(document.getElementById('totalAmount')?.value) || 0;
                const advanceAmount = parseFloat(document.getElementById('advanceAmount')?.value) || 0;
                
                // Get the selected category
                const categoryDropdown = document.getElementById('categoryDropdown');
                const category = categoryDropdown ? categoryDropdown.value : 'blouse';
                
                // Create a new order in the database
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customer_id: customer.id,
                        amount: amount,
                        advance_amount: advanceAmount,
                        category: category
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to create new order');
                }
                
                // Show success message
                showAlert('New order created successfully!', 'success');
                
                // Close the modal
                const searchCustomerModal = bootstrap.Modal.getInstance(document.getElementById('searchCustomerModal'));
                searchCustomerModal.hide();
                
                // Reset the measurement form
                const measurementForm = document.getElementById('measurementForm');
                if (measurementForm) {
                    measurementForm.reset();
                    // Set the customer ID in the form
                    const customerIdInput = document.getElementById('customer_id');
                    if (customerIdInput) {
                        customerIdInput.value = customer.id;
                    }
                }
                
                // Reset any file inputs
                const fileInputs = document.querySelectorAll('input[type="file"]');
                fileInputs.forEach(input => {
                    input.value = '';
                    const preview = input.closest('.mb-3')?.querySelector('img');
                    if (preview) {
                        preview.src = '#';
                        preview.style.display = 'none';
                    }
                });
                
                // Reset any image previews
                const imagePreviews = document.querySelectorAll('.image-preview');
                imagePreviews.forEach(preview => {
                    preview.src = '#';
                    preview.style.display = 'none';
                });
                
                // Reset the category dropdown
                const categoryDropdown2 = document.getElementById('categoryDropdown');
                if (categoryDropdown2) {
                    categoryDropdown2.selectedIndex = 0;
                    categoryDropdown2.dispatchEvent(new Event('change'));
                }
                
                // Reset the button state
                newOrderBtn.disabled = false;
                newOrderBtn.innerHTML = originalText;
                
            } catch (error) {
                console.error('Error creating order:', error);
                showAlert(error.message || 'Failed to create new order', 'danger');
                newOrderBtn.disabled = false;
                newOrderBtn.innerHTML = originalText;
            }
            
            // Hide all measurement categories
            document.querySelectorAll('.measurement-category').forEach(section => {
                section.style.display = 'none';
            });
            
            // Reset order and delivery dates
            document.getElementById('orderDate').value = '';
            document.getElementById('deliveryDate').value = '';
            
            // Reset advance amount
            document.getElementById('advanceAmount').value = '';
            
            // Populate customer details
            const customerId = customer.id || '';
            document.getElementById('customer_id').value = customerId;
            document.getElementById('displayCustomerName').textContent = customer.name || 'N/A';
            document.getElementById('displayCustomerEmail').textContent = customer.email || 'N/A';
            document.getElementById('displayCustomerPhone').textContent = customer.phone || 'N/A';
            document.getElementById('displayCustomerAddress').textContent = customer.address || 'N/A';
            
            // Set customer ID as data attribute for reference
            const customerDetailsSection = document.getElementById('customerDetailsSection');
            if (customerDetailsSection) {
                customerDetailsSection.dataset.customerId = customerId;
            }
            
            // Show the customer details section and hide others
            document.getElementById('customerSelectionScreen').style.display = 'none';
            document.getElementById('customerDetailsSection').style.display = 'block';
            document.getElementById('newCustomerForm').style.display = 'none';
            
            // Show the measurement section and form
            const measurementSection = document.getElementById('measurementSection');
            if (measurementSection) {
                measurementSection.style.display = 'block';
            }
            
            const measurementsCollapse = document.getElementById('measurementsCollapse');
            if (measurementsCollapse) {
                measurementsCollapse.style.display = 'block';
            }
            
            if (measurementForm) {
                measurementForm.style.display = 'block';
            }
            
            // Enable category selection
            if (categoryDropdown) {
                categoryDropdown.disabled = false;
                categoryDropdown.classList.remove('disabled');
            }
            
            // Enable all category items
            const categoryItems = document.querySelectorAll('.pattern-category');
            categoryItems.forEach(item => {
                item.style.pointerEvents = 'auto';
                item.style.opacity = '1';
            });
            
            // Initialize the category selection
            updateMeasurementFields('');
            
            // Set focus to the category dropdown
            if (categoryDropdown) {
                categoryDropdown.focus();
            }
            
            // Show success message
            showAlert('New order started. Please select a pattern category to continue.', 'success');
        };
        
        searchResults.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">${customer.name || 'No Name'}</h5>
                    <div class="mb-2">
                        <i class="bi bi-telephone me-2"></i> ${customer.phone || 'N/A'}
                    </div>
                    ${customer.email ? `
                        <div class="mb-2">
                            <i class="bi bi-envelope me-2"></i> ${customer.email}
                        </div>` : ''}
                    ${customer.address ? `
                        <div class="mb-2">
                            <i class="bi bi-geo-alt me-2"></i> ${customer.address}
                        </div>` : ''}
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="amount-display">
                            ${isPaid ? `
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                <strong>Status:</strong> Paid (â‚¹${amount.toFixed(2)})
                            ` : `
                                <i class="bi bi-cash-coin me-2"></i>
                                <strong>Amount Due:</strong> â‚¹${amountDue.toFixed(2)}
                            `}
                        </div>
                        ${!isPaid ? `
                            <button class="btn btn-sm btn-success mark-paid" 
                                    data-id="${customer.id}"
                                    data-amount="${amountDue}"> 
                                <i class="bi bi-currency-rupee me-1"></i> Mark as Paid
                            </button>
                        ` : `
                            <button class="btn btn-sm btn-outline-secondary" disabled>
                                <i class="bi bi-check2-all me-1"></i> Paid
                            </button>
                        `}
                    </div>
                </div>
            </div>`;

        // Add event listener to the mark as paid button
        const markPaidBtn = searchResults.querySelector('.mark-paid');
        if (markPaidBtn) {
            markPaidBtn.addEventListener('click', async function() {
                const customerId = this.getAttribute('data-id');
                const amount = this.getAttribute('data-amount');
                
                // Show loading state
                const originalText = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Processing...';
                this.disabled = true;
                
                try {
                    // Make API call to update payment status
                    const response = await fetch(`/customer/${customerId}/update_payment`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // Find the amount display and update it
                        const amountDisplay = this.closest('.card-body').querySelector('.amount-display');
                        if (amountDisplay) {
                            amountDisplay.innerHTML = `
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                <strong>Status:</strong> Paid (â‚¹${parseFloat(amount || '0').toFixed(2)})
                            `;
                        }
                        
                        // Disable the paid button
                        this.classList.remove('btn-success');
                        this.classList.add('btn-outline-secondary');
                        this.innerHTML = '<i class="bi bi-check2-all me-1"></i> Paid';
                        this.disabled = true;
                        
                        // Show success message
                        const successAlert = document.createElement('div');
                        successAlert.className = 'alert alert-success mt-3 mb-0';
                        successAlert.innerHTML = `
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Payment of â‚¹${parseFloat(amount || '0').toFixed(2)} marked as paid successfully!
                        `;
                        
                        // Insert the alert after the amount display
                        this.closest('.d-flex').insertAdjacentElement('afterend', successAlert);
                    } else {
                        throw new Error(data.error || 'Failed to update payment status');
                    }
                    
                } catch (error) {
                    console.error('Error marking payment as paid:', error);
                    this.innerHTML = originalText;
                    this.disabled = false;
                    
                    // Show error message
                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'alert alert-danger mt-3 mb-0';
                    errorAlert.innerHTML = `
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        ${error.message || 'Failed to mark payment as paid. Please try again.'}
                    `;
                    this.closest('.card-body').appendChild(errorAlert);
                }
            });
        }
    }

    // Handle amount update
    const updateAmountBtn = document.getElementById('updateAmountBtn');
    const updateAmountModal = new bootstrap.Modal(document.getElementById('updateAmountModal'));
    const saveAmountBtn = document.getElementById('saveAmountBtn');
    const amountInput = document.getElementById('amount');
    const displayAmount = document.getElementById('displayCustomerAmount');
    const advanceAmountInput = document.getElementById('advanceAmount');
    
    // Enable/disable advance amount field based on total amount
    function updateAdvanceAmountField() {
        const totalAmount = parseFloat(displayAmount.textContent) || 0;
        advanceAmountInput.disabled = totalAmount <= 0;
        if (totalAmount <= 0) {
            advanceAmountInput.value = '';
        } else if (parseFloat(advanceAmountInput.value) > totalAmount) {
            advanceAmountInput.value = totalAmount.toFixed(2);
        }
    }
    
    // Update advance amount field when total amount changes
    const observer = new MutationObserver(updateAdvanceAmountField);
    observer.observe(displayAmount, { childList: true, characterData: true, subtree: true });
    let currentCustomerId = null;

    // Show add amount modal
    if (updateAmountBtn) {
        updateAmountBtn.addEventListener('click', function() {
            currentCustomerId = document.getElementById('customer_id').value;
            if (!currentCustomerId) {
                showAlert('No customer selected', 'danger');
                return;
            }
            amountInput.value = displayAmount.textContent || '0.0';
            updateAmountModal.show();
        });
    }

    // Save amount
    if (saveAmountBtn) {
        saveAmountBtn.addEventListener('click', async function() {
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount < 0) {
                amountInput.classList.add('is-invalid');
                return;
            }

            try {
                const response = await fetch(`/customer/${currentCustomerId}/amount`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ amount: amount })
                });

                if (!response.ok) {
                    throw new Error('Failed to add amount');
                }

                const data = await response.json();
                displayAmount.textContent = amount.toFixed(2);
                updateAmountModal.hide();
                showAlert('Amount added successfully', 'success');
            } catch (error) {
                console.error('Error updating amount:', error);
                showAlert('Failed to add amount: ' + error.message, 'danger');
            }
        });
    }

    // Clear amount when clearing customer data
    document.getElementById('displayCustomerAmount').textContent = '0.00';
</script>
{% endblock %}
